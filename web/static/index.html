<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Taskgraph</title>
<style>
  :root { --bg: #0a0a0a; --fg: #e0e0e0; --dim: #666; --accent: #4fc3f7; --green: #66bb6a; --red: #ef5350; --border: #333; --surface: #141414; }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'SF Mono', 'Cascadia Code', 'Consolas', monospace; font-size: 13px; background: var(--bg); color: var(--fg); min-height: 100vh; display: flex; flex-direction: column; }
  .container { max-width: 900px; margin: 0 auto; padding: 24px 16px; width: 100%; }
  h1 { font-size: 18px; font-weight: 600; margin-bottom: 24px; color: var(--accent); }
  h2 { font-size: 14px; font-weight: 600; margin-bottom: 12px; color: var(--fg); }
  label { display: block; font-size: 12px; color: var(--dim); margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px; }

  /* Form layout */
  .form-section { margin-bottom: 20px; }
  .form-row { display: flex; gap: 12px; margin-bottom: 12px; }
  .form-row > * { flex: 1; }

  select, input[type="file"] { width: 100%; background: var(--surface); border: 1px solid var(--border); color: var(--fg); padding: 8px 10px; border-radius: 4px; font-family: inherit; font-size: 13px; }
  select:focus, input:focus { outline: none; border-color: var(--accent); }
  select option { background: var(--surface); }

  /* Drop zone */
  .drop-zone { border: 2px dashed var(--border); border-radius: 6px; padding: 24px; text-align: center; color: var(--dim); cursor: pointer; transition: border-color 0.2s, color 0.2s; }
  .drop-zone:hover, .drop-zone.dragover { border-color: var(--accent); color: var(--accent); }
  .drop-zone input { display: none; }
  .file-list { margin-top: 8px; font-size: 12px; color: var(--fg); }
  .file-list .file-item { display: inline-block; background: var(--surface); border: 1px solid var(--border); border-radius: 3px; padding: 2px 8px; margin: 2px 4px 2px 0; }
  .file-item .remove { color: var(--red); cursor: pointer; margin-left: 6px; }

  /* Buttons */
  button { background: var(--accent); color: var(--bg); border: none; padding: 10px 24px; border-radius: 4px; font-family: inherit; font-size: 13px; font-weight: 600; cursor: pointer; transition: opacity 0.2s; }
  button:hover { opacity: 0.85; }
  button:disabled { opacity: 0.4; cursor: not-allowed; }
  .btn-row { display: flex; gap: 8px; margin-top: 16px; }

  /* Console */
  .console { background: var(--surface); border: 1px solid var(--border); border-radius: 6px; padding: 12px 16px; margin-top: 20px; min-height: 200px; max-height: 500px; overflow-y: auto; white-space: pre-wrap; word-break: break-all; font-size: 12px; line-height: 1.6; display: none; }
  .console.active { display: block; }
  .console .line-error { color: var(--red); }
  .console .line-info { color: var(--dim); }

  /* Results */
  .results { margin-top: 16px; display: none; }
  .results.active { display: block; }
  .results-bar { display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-radius: 6px; margin-bottom: 12px; }
  .results-bar.pass { background: rgba(102, 187, 106, 0.1); border: 1px solid rgba(102, 187, 106, 0.3); }
  .results-bar.fail { background: rgba(239, 83, 80, 0.1); border: 1px solid rgba(239, 83, 80, 0.3); }
  .results-bar .status { font-weight: 600; }
  .results-bar.pass .status { color: var(--green); }
  .results-bar.fail .status { color: var(--red); }

  .download-links { display: flex; gap: 8px; flex-wrap: wrap; }
  .download-links a { display: inline-block; background: var(--surface); border: 1px solid var(--border); border-radius: 4px; padding: 6px 14px; color: var(--accent); text-decoration: none; font-size: 12px; transition: border-color 0.2s; }
  .download-links a:hover { border-color: var(--accent); }
</style>
</head>
<body>
<div class="container">
  <h1>Taskgraph</h1>

  <!-- Spec selection -->
  <div class="form-section">
    <label>Spec</label>
    <div class="form-row">
      <div>
        <select id="spec-select">
          <option value="">-- select built-in --</option>
        </select>
      </div>
      <div>
        <input type="file" id="spec-file" accept=".py">
      </div>
    </div>
  </div>

  <!-- Data files -->
  <div class="form-section">
    <label>Data Files (optional â€” for specs that load from uploads)</label>
    <div class="drop-zone" id="drop-zone">
      Drop .csv / .xlsx files here, or click to browse
      <input type="file" id="data-files" multiple accept=".csv,.xlsx,.xls">
    </div>
    <div class="file-list" id="file-list"></div>
  </div>

  <!-- Model config -->
  <div class="form-section">
    <div class="form-row">
      <div>
        <label>Model</label>
        <select id="model">
          <option value="openai/gpt-5.2">openai/gpt-5.2</option>
          <option value="google/gemini-3-flash-preview">google/gemini-3-flash-preview</option>
          <option value="google/gemini-3-pro-preview">google/gemini-3-pro-preview</option>
          <option value="anthropic/claude-sonnet-4">anthropic/claude-sonnet-4</option>
        </select>
      </div>
      <div>
        <label>Reasoning Effort</label>
        <select id="reasoning-effort">
          <option value="low">low</option>
          <option value="medium">medium</option>
          <option value="high">high</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Run -->
  <div class="btn-row">
    <button id="run-btn" onclick="startRun()">Run</button>
  </div>

  <!-- Console output -->
  <div class="console" id="console"></div>

  <!-- Results -->
  <div class="results" id="results">
    <div class="results-bar" id="results-bar">
      <span class="status" id="results-status"></span>
      <span id="results-detail"></span>
    </div>
    <div class="download-links" id="download-links"></div>
  </div>
</div>

<script>
const $ = id => document.getElementById(id);
let dataFiles = [];
let currentRunId = null;

// Load built-in specs
fetch('/api/specs').then(r => r.json()).then(specs => {
  const sel = $('spec-select');
  specs.forEach(s => {
    const opt = document.createElement('option');
    opt.value = s.id;
    opt.textContent = s.id;
    sel.appendChild(opt);
  });
});

// Spec file clears select and vice versa
$('spec-select').addEventListener('change', () => { if ($('spec-select').value) $('spec-file').value = ''; });
$('spec-file').addEventListener('change', () => { if ($('spec-file').files.length) $('spec-select').value = ''; });

// Drop zone
const dz = $('drop-zone');
dz.addEventListener('click', () => $('data-files').click());
dz.addEventListener('dragover', e => { e.preventDefault(); dz.classList.add('dragover'); });
dz.addEventListener('dragleave', () => dz.classList.remove('dragover'));
dz.addEventListener('drop', e => {
  e.preventDefault();
  dz.classList.remove('dragover');
  addFiles(e.dataTransfer.files);
});
$('data-files').addEventListener('change', e => addFiles(e.target.files));

function addFiles(files) {
  for (const f of files) {
    if (!dataFiles.some(d => d.name === f.name)) dataFiles.push(f);
  }
  renderFileList();
}

function removeFile(name) {
  dataFiles = dataFiles.filter(f => f.name !== name);
  renderFileList();
}

function renderFileList() {
  const el = $('file-list');
  el.innerHTML = dataFiles.map(f =>
    `<span class="file-item">${f.name}<span class="remove" onclick="removeFile('${f.name}')">&times;</span></span>`
  ).join('');
}

async function startRun() {
  const btn = $('run-btn');
  btn.disabled = true;

  const con = $('console');
  con.innerHTML = '';
  con.classList.add('active');
  $('results').classList.remove('active');

  const fd = new FormData();
  fd.append('model', $('model').value);
  fd.append('reasoning_effort', $('reasoning-effort').value);

  const specFile = $('spec-file').files[0];
  const specId = $('spec-select').value;
  if (specFile) {
    fd.append('spec_file', specFile);
  } else if (specId) {
    fd.append('spec_id', specId);
  } else {
    appendLog('ERROR: Select a spec or upload a spec file', true);
    btn.disabled = false;
    return;
  }

  for (const f of dataFiles) fd.append('data_files', f);

  try {
    const resp = await fetch('/api/run', { method: 'POST', body: fd });
    if (!resp.ok) {
      const err = await resp.json();
      appendLog('ERROR: ' + (err.detail || resp.statusText), true);
      btn.disabled = false;
      return;
    }
    const { run_id } = await resp.json();
    currentRunId = run_id;
    streamLogs(run_id);
  } catch (e) {
    appendLog('ERROR: ' + e.message, true);
    btn.disabled = false;
  }
}

function streamLogs(runId) {
  const es = new EventSource(`/api/run/${runId}/stream`);

  es.addEventListener('log', e => appendLog(e.data));
  es.addEventListener('done', e => {
    es.close();
    $('run-btn').disabled = false;
    showResults(runId, e.data);
  });
  es.addEventListener('result', e => {
    // result JSON arrives after done
  });
  es.onerror = () => {
    es.close();
    $('run-btn').disabled = false;
  };
}

function appendLog(text, isError = false) {
  const con = $('console');
  const line = document.createElement('div');
  if (isError || text.startsWith('ERROR') || text.startsWith('Aborting')) {
    line.className = 'line-error';
  }
  line.textContent = text;
  con.appendChild(line);
  con.scrollTop = con.scrollHeight;
}

async function showResults(runId, status) {
  const bar = $('results-bar');
  const links = $('download-links');
  links.innerHTML = '';

  const ok = status === 'done';
  bar.className = 'results-bar ' + (ok ? 'pass' : 'fail');
  $('results-status').textContent = ok ? 'PASSED' : 'FAILED';
  $('results-detail').textContent = '';

  // DB download
  links.innerHTML += `<a href="/api/run/${runId}/download/db">Download output.db</a>`;

  // Exports
  try {
    const exports = await fetch(`/api/run/${runId}/exports`).then(r => r.json());
    for (const exp of exports) {
      links.innerHTML += `<a href="/api/run/${runId}/download/export/${exp.name}">${exp.name}</a>`;
    }
  } catch (e) {}

  $('results').classList.add('active');
}
</script>
</body>
</html>
